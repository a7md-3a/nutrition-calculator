<script>
/* =========================
   بيانات الوجبات — يمكن توسيعها لاحقًا
========================= */
const mealsDB = {
  breakfast: [
    [
      {food:'4 بيضات أومليت', qty:'4 بيضات', kcal:320, protein:28, carbs:2, fat:22},
      {food:'توست أسمر', qty:'2 قطعة', kcal:160, protein:6, carbs:30, fat:2},
      {food:'عصير فواكه طبيعي', qty:'1 كوب', kcal:100, protein:0, carbs:25, fat:0}
    ],
    [
      {food:'شوفان مطبوخ', qty:'1 كوب', kcal:220, protein:8, carbs:40, fat:6},
      {food:'موز', qty:'1', kcal:100, protein:1, carbs:27, fat:0}
    ]
  ],
  lunch: [
    [
      {food:'صدر دجاج مشوي', qty:'180 غ', kcal:300, protein:40, carbs:0, fat:8},
      {food:'أرز بني', qty:'150 غ', kcal:180, protein:4, carbs:40, fat:2},
      {food:'سلطة خضراء', qty:'طبق', kcal:60, protein:2, carbs:8, fat:4}
    ],
    [
      {food:'لحم بقري قليل الدهن', qty:'200 غ', kcal:420, protein:45, carbs:0, fat:22},
      {food:'بطاطا مشوية', qty:'200 غ', kcal:180, protein:3, carbs:40, fat:1}
    ]
  ],
  dinner: [
    [
      {food:'سلمون مشوي', qty:'150 غ', kcal:350, protein:35, carbs:0, fat:20},
      {food:'خضار سوتيه', qty:'طبق', kcal:80, protein:3, carbs:10, fat:2}
    ],
    [
      {food:'حساء خضار', qty:'1 وعاء', kcal:150, protein:6, carbs:28, fat:3},
      {food:'جبن قريش', qty:'100 غ', kcal:100, protein:20, carbs:4, fat:1}
    ]
  ],
  snack: [
    {food:'تفاحة', qty:'1', kcal:95, protein:0, carbs:25, fat:0},
    {food:'حفنة لوز', qty:'20 غ', kcal:120, protein:4, carbs:5, fat:10},
    {food:'زبادي قليل الدسم', qty:'1 كوب', kcal:100, protein:6, carbs:15, fat:2}
  ],
  drink: [
    {food:'ماء', qty:'2 لتر', kcal:0, protein:0, carbs:0, fat:0},
    {food:'شاي أخضر', qty:'1 كوب', kcal:0, protein:0, carbs:0, fat:0}
  ]
};

/* =========================
   أدوات مساعدة
========================= */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const STORAGE_KEY = 'ahmed_calc_saved';

function calculateBMR(weight,height,age,gender){
  if(gender==='male') return 10*weight + 6.25*height - 5*age + 5;
  return 10*weight + 6.25*height - 5*age - 161;
}

function calculateBMI(weight,height){
  const v = +(weight / ((height/100)**2)).toFixed(1);
  let cat = '';
  if(v<18.5) cat='نقص في الوزن';
  else if(v<24.9) cat='وزن طبيعي';
  else if(v<29.9) cat='زيادة في الوزن';
  else if(v<34.9) cat='سمنة الدرجة الأولى';
  else cat='سمنة مفرطة';
  return {value:v,category:cat};
}

/* =========================
   توليد خطة يومية
========================= */
function generateDailyPlan(targetCalories){
  const plan = { breakfast:[], snack1:[], lunch:[], snack2:[], dinner:[], drink:[] };
  const ratios = { breakfast:0.25, snack1:0.05, lunch:0.35, snack2:0.05, dinner:0.30 };

  for(const key in ratios){
    const budget = Math.round(targetCalories * ratios[key]);
    if(key.startsWith('snack')){
      const candidates = mealsDB.snack.filter(s => (s.kcal||0) <= Math.max(60,budget));
      plan[key] = candidates.length ? [ pick(candidates) ] : [ pick(mealsDB.snack) ];
    } else {
      const templates = mealsDB[key] || [];
      if(!templates.length){ plan[key]=[]; continue; }
      const suitable = templates.filter(t => t.reduce((acc,i)=>acc+(i.kcal||0),0) <= Math.max(100,budget));
      const chosen = suitable.length ? pick(suitable) : pick(templates);
      plan[key] = chosen.map(i => Object.assign({}, i));
    }
  }
  plan.drink = mealsDB.drink.slice();
  return plan;
}

/* =========================
   Helpers لتنسيق الخطة
========================= */
function label(meal){
  if(meal==='breakfast') return 'الفطور';
  if(meal==='lunch') return 'الغداء';
  if(meal==='dinner') return 'العشاء';
  if(meal==='snack1') return 'وجبة خفيفة 1';
  if(meal==='snack2') return 'وجبة خفيفة 2';
  if(meal==='drink') return 'المشروبات';
  return meal;
}

function safeNum(v){ return Number.isFinite(+v) ? +v : 0; }

function renderMealHtml(mealName, items){
  if(!items || !items.length) return '';
  let totalK=0, totalP=0, totalC=0, totalF=0;
  let out = `<div class="meal-card"><div class="meal-title">${label(mealName)}</div><div class="meal-items">`;
  items.forEach(it=>{
    const kcal=safeNum(it.kcal), p=safeNum(it.protein), c=safeNum(it.carbs), f=safeNum(it.fat);
    totalK+=kcal; totalP+=p; totalC+=c; totalF+=f;
    out += `<div class="meal-item"><div><strong>${it.qty}</strong> &nbsp; ${it.food}</div><div class="kcal-pill">${kcal} kcal</div></div>`;
    out += `<div class="meta-small"><span class="me-3">${p}g بروتين</span><span class="me-3">${c}g كارب</span><span>${f}g دهون</span></div>`;
  });
  out += `</div><div class="small-muted mt-2"><strong>مجموع:</strong> ${totalK} سعره حرارية (${totalK} kcal) — ${Math.round(totalP)}g بروتين — ${Math.round(totalC)}g كارب — ${Math.round(totalF)}g دهون</div></div>`;
  return out;
}

/* =========================
   Render الخطة الكاملة 30 يوم
========================= */
function renderFullPlan(age,gender,height,weight,activity,goal){
  let bmr = Math.round(calculateBMR(weight,height,age,gender));
  let tdee = Math.round(bmr * activity);
  if(goal==='lose') tdee = Math.max(1000, Math.round(tdee * 0.9));
  else if(goal==='gain') tdee = Math.round(tdee * 1.15);

  const bmi = calculateBMI(weight,height);

  let html = `<div class="panel mb-3" style="background:transparent;border:none;padding:0">`;
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px"><div style="flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px"><strong>العمر:</strong> ${age} سنة<br><strong>الجنس:</strong> ${gender==='male'?'ذكر':'أنثى'}<br><strong>الطول:</strong> ${height} سم<br><strong>الوزن:</strong> ${weight} كغ</div>`;
  html += `<div style="flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px"><strong>BMI:</strong> ${bmi.value} — ${bmi.category}<br><strong>BMR:</strong> ${bmr} سعره حرارية (${bmr} kcal)<br><strong>TDEE تقريبي:</strong> ${tdee} سعره حرارية (${tdee} kcal)</div></div>`;
  html += `</div>`;

  html += `<h4 style="color:var(--gold)">الخطة الغذائية — 30 يوم</h4>`;
  html += `<p class="small-muted">نطاق السعرات اليومي الموصى: <strong>${tdee}</strong> سعره حرارية (${tdee} kcal). الخطط تقريبية — راجع أخصائي تغذية للحالات الخاصة.</p>`;

  for(let d=1; d<=30; d++){
    try{
      const dayPlan = generateDailyPlan(tdee);
      html += `<div class="card-day">`;
      html += `<div class="day-header"><div><strong>اليوم ${d}</strong></div><div><span class="goal-badge ${goal==='lose'?'goal-lose':goal==='gain'?'goal-gain':'goal-maintain'}">${goal==='lose'?'خسارة وزن':goal==='gain'?'زيادة وزن':'حفاظ'}</span></div></div>`;
      html += renderMealHtml('breakfast', dayPlan.breakfast || []);
      if(dayPlan.snack1 && dayPlan.snack1.length) html += renderMealHtml('snack1', dayPlan.snack1);
      html += renderMealHtml('lunch', dayPlan.lunch || []);
      if(dayPlan.snack2 && dayPlan.snack2.length) html += renderMealHtml('snack2', dayPlan.snack2);
      html += renderMealHtml('dinner', dayPlan.dinner || []);
      if(dayPlan.drink && dayPlan.drink.length) html += renderMealHtml('drink', dayPlan.drink);
      html += `</div>`;
    } catch(err){ console.error('خطأ في توليد اليوم', d, err);}
  }

  html += `<div style="text-align:center;margin-top:12px" class="small-muted">اضغط "حفظ التقدم" لحفظ المدخلات والخطة محلياً على جهازك</div>`;

  return {html,meta:{bmr,tdee,bmi}};
}
</script>

<script>
/* =========================
   بيانات الوجبات — يمكن توسيعها لاحقًا
========================= */
const mealsDB = {
  breakfast: [
    [
      {food:'4 بيضات أومليت', qty:'4 بيضات', kcal:320, protein:28, carbs:2, fat:22},
      {food:'توست أسمر', qty:'2 قطعة', kcal:160, protein:6, carbs:30, fat:2},
      {food:'عصير فواكه طبيعي', qty:'1 كوب', kcal:100, protein:0, carbs:25, fat:0}
    ],
    [
      {food:'شوفان مطبوخ', qty:'1 كوب', kcal:220, protein:8, carbs:40, fat:6},
      {food:'موز', qty:'1', kcal:100, protein:1, carbs:27, fat:0}
    ]
  ],
  lunch: [
    [
      {food:'صدر دجاج مشوي', qty:'180 غ', kcal:300, protein:40, carbs:0, fat:8},
      {food:'أرز بني', qty:'150 غ', kcal:180, protein:4, carbs:40, fat:2},
      {food:'سلطة خضراء', qty:'طبق', kcal:60, protein:2, carbs:8, fat:4}
    ],
    [
      {food:'لحم بقري قليل الدهن', qty:'200 غ', kcal:420, protein:45, carbs:0, fat:22},
      {food:'بطاطا مشوية', qty:'200 غ', kcal:180, protein:3, carbs:40, fat:1}
    ]
  ],
  dinner: [
    [
      {food:'سلمون مشوي', qty:'150 غ', kcal:350, protein:35, carbs:0, fat:20},
      {food:'خضار سوتيه', qty:'طبق', kcal:80, protein:3, carbs:10, fat:2}
    ],
    [
      {food:'حساء خضار', qty:'1 وعاء', kcal:150, protein:6, carbs:28, fat:3},
      {food:'جبن قريش', qty:'100 غ', kcal:100, protein:20, carbs:4, fat:1}
    ]
  ],
  snack: [
    {food:'تفاحة', qty:'1', kcal:95, protein:0, carbs:25, fat:0},
    {food:'حفنة لوز', qty:'20 غ', kcal:120, protein:4, carbs:5, fat:10},
    {food:'زبادي قليل الدسم', qty:'1 كوب', kcal:100, protein:6, carbs:15, fat:2}
  ],
  drink: [
    {food:'ماء', qty:'2 لتر', kcal:0, protein:0, carbs:0, fat:0},
    {food:'شاي أخضر', qty:'1 كوب', kcal:0, protein:0, carbs:0, fat:0}
  ]
};

/* =========================
   أدوات مساعدة
========================= */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const STORAGE_KEY = 'ahmed_calc_saved';

function calculateBMR(weight,height,age,gender){
  if(gender==='male') return 10*weight + 6.25*height - 5*age + 5;
  return 10*weight + 6.25*height - 5*age - 161;
}

function calculateBMI(weight,height){
  const v = +(weight / ((height/100)**2)).toFixed(1);
  let cat = '';
  if(v<18.5) cat='نقص في الوزن';
  else if(v<24.9) cat='وزن طبيعي';
  else if(v<29.9) cat='زيادة في الوزن';
  else if(v<34.9) cat='سمنة الدرجة الأولى';
  else cat='سمنة مفرطة';
  return {value:v,category:cat};
}

/* =========================
   توليد خطة يومية
========================= */
function generateDailyPlan(targetCalories){
  const plan = { breakfast:[], snack1:[], lunch:[], snack2:[], dinner:[], drink:[] };
  const ratios = { breakfast:0.25, snack1:0.05, lunch:0.35, snack2:0.05, dinner:0.30 };

  for(const key in ratios){
    const budget = Math.round(targetCalories * ratios[key]);
    if(key.startsWith('snack')){
      const candidates = mealsDB.snack.filter(s => (s.kcal||0) <= Math.max(60,budget));
      plan[key] = candidates.length ? [ pick(candidates) ] : [ pick(mealsDB.snack) ];
    } else {
      const templates = mealsDB[key] || [];
      if(!templates.length){ plan[key]=[]; continue; }
      const suitable = templates.filter(t => t.reduce((acc,i)=>acc+(i.kcal||0),0) <= Math.max(100,budget));
      const chosen = suitable.length ? pick(suitable) : pick(templates);
      plan[key] = chosen.map(i => Object.assign({}, i));
    }
  }
  plan.drink = mealsDB.drink.slice();
  return plan;
}

/* =========================
   Helpers لتنسيق الخطة
========================= */
function label(meal){
  if(meal==='breakfast') return 'الفطور';
  if(meal==='lunch') return 'الغداء';
  if(meal==='dinner') return 'العشاء';
  if(meal==='snack1') return 'وجبة خفيفة 1';
  if(meal==='snack2') return 'وجبة خفيفة 2';
  if(meal==='drink') return 'المشروبات';
  return meal;
}

function safeNum(v){ return Number.isFinite(+v) ? +v : 0; }

function renderMealHtml(mealName, items){
  if(!items || !items.length) return '';
  let totalK=0, totalP=0, totalC=0, totalF=0;
  let out = `<div class="meal-card"><div class="meal-title">${label(mealName)}</div><div class="meal-items">`;
  items.forEach(it=>{
    const kcal=safeNum(it.kcal), p=safeNum(it.protein), c=safeNum(it.carbs), f=safeNum(it.fat);
    totalK+=kcal; totalP+=p; totalC+=c; totalF+=f;
    out += `<div class="meal-item"><div><strong>${it.qty}</strong> &nbsp; ${it.food}</div><div class="kcal-pill">${kcal} kcal</div></div>`;
    out += `<div class="meta-small"><span class="me-3">${p}g بروتين</span><span class="me-3">${c}g كارب</span><span>${f}g دهون</span></div>`;
  });
  out += `</div><div class="small-muted mt-2"><strong>مجموع:</strong> ${totalK} سعره حرارية (${totalK} kcal) — ${Math.round(totalP)}g بروتين — ${Math.round(totalC)}g كارب — ${Math.round(totalF)}g دهون</div></div>`;
  return out;
}

/* =========================
   Render الخطة الكاملة 30 يوم
========================= */
function renderFullPlan(age,gender,height,weight,activity,goal){
  let bmr = Math.round(calculateBMR(weight,height,age,gender));
  let tdee = Math.round(bmr * activity);
  if(goal==='lose') tdee = Math.max(1000, Math.round(tdee * 0.9));
  else if(goal==='gain') tdee = Math.round(tdee * 1.15);

  const bmi = calculateBMI(weight,height);

  let html = `<div class="panel mb-3" style="background:transparent;border:none;padding:0">`;
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px"><div style="flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px"><strong>العمر:</strong> ${age} سنة<br><strong>الجنس:</strong> ${gender==='male'?'ذكر':'أنثى'}<br><strong>الطول:</strong> ${height} سم<br><strong>الوزن:</strong> ${weight} كغ</div>`;
  html += `<div style="flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px"><strong>BMI:</strong> ${bmi.value} — ${bmi.category}<br><strong>BMR:</strong> ${bmr} سعره حرارية (${bmr} kcal)<br><strong>TDEE تقريبي:</strong> ${tdee} سعره حرارية (${tdee} kcal)</div></div>`;
  html += `</div>`;

  html += `<h4 style="color:var(--gold)">الخطة الغذائية — 30 يوم</h4>`;
  html += `<p class="small-muted">نطاق السعرات اليومي الموصى: <strong>${tdee}</strong> سعره حرارية (${tdee} kcal). الخطط تقريبية — راجع أخصائي تغذية للحالات الخاصة.</p>`;

  for(let d=1; d<=30; d++){
    try{
      const dayPlan = generateDailyPlan(tdee);
      html += `<div class="card-day">`;
      html += `<div class="day-header"><div><strong>اليوم ${d}</strong></div><div><span class="goal-badge ${goal==='lose'?'goal-lose':goal==='gain'?'goal-gain':'goal-maintain'}">${goal==='lose'?'خسارة وزن':goal==='gain'?'زيادة وزن':'حفاظ'}</span></div></div>`;
      html += renderMealHtml('breakfast', dayPlan.breakfast || []);
      if(dayPlan.snack1 && dayPlan.snack1.length) html += renderMealHtml('snack1', dayPlan.snack1);
      html += renderMealHtml('lunch', dayPlan.lunch || []);
      if(dayPlan.snack2 && dayPlan.snack2.length) html += renderMealHtml('snack2', dayPlan.snack2);
      html += renderMealHtml('dinner', dayPlan.dinner || []);
      if(dayPlan.drink && dayPlan.drink.length) html += renderMealHtml('drink', dayPlan.drink);
      html += `</div>`;
    } catch(err){ console.error('خطأ في توليد اليوم', d, err);}
  }

  html += `<div style="text-align:center;margin-top:12px" class="small-muted">اضغط "حفظ التقدم" لحفظ المدخلات والخطة محلياً على جهازك</div>`;

  return {html,meta:{bmr,tdee,bmi}};
}
</script>

<script>
/* =========================
   حفظ / تحميل / مسح الحالة
========================= */
function saveState(state){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); return true; }
  catch(e){ console.error('save error',e); return false; }
}
function loadState(){
  try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):null; }catch(e){return null;}
}
function clearState(){ try{ localStorage.removeItem(STORAGE_KEY); return true;}catch(e){return false;}}

/* =========================
   UI Wiring
========================= */
const form = document.getElementById('form');
const resEl = document.getElementById('result');
const loadingEl = document.getElementById('loading');
const btnSave = document.getElementById('save');
const btnLoad = document.getElementById('load');
const btnClear = document.getElementById('clear');

function showLoading(on=true){
  loadingEl.style.display = on ? 'block' : 'none';
}
function showResult(html){
  resEl.innerHTML = html;
  resEl.style.display = 'block';
  window.scrollTo({top: resEl.offsetTop-12, behavior:'smooth'});
}

/* Load saved at start */
window.addEventListener('load', ()=>{
  const s = loadState();
  if(s && s.inputs){
    try{
      document.getElementById('age').value = s.inputs.age || '';
      document.getElementById('gender').value = s.inputs.gender || '';
      document.getElementById('height').value = s.inputs.height || '';
      document.getElementById('weight').value = s.inputs.weight || '';
      document.getElementById('activity').value = s.inputs.activity || '';
      document.getElementById('goal').value = s.inputs.goal || '';
      if(s.planHtml){
        resEl.innerHTML = `<div class="small-muted" style="margin-bottom:10px">تم استرجاع آخر حفظ — يمكنك تعديل المدخلات ثم حفظ جديد.</div>` + s.planHtml;
        resEl.style.display = 'block';
      }
    }catch(e){ console.warn('load populate error',e); }
  }
});

/* Generate */
form.addEventListener('submit', e=>{
  e.preventDefault();
  const age = Number(document.getElementById('age').value);
  const gender = document.getElementById('gender').value;
  const height = Number(document.getElementById('height').value);
  const weight = Number(document.getElementById('weight').value);
  const activity = Number(document.getElementById('activity').value);
  const goal = document.getElementById('goal').value;

  if(!age || !gender || !height || !weight || !activity || !goal){
    alert('يرجى تعبئة جميع الحقول بشكل صحيح.');
    return;
  }

  showLoading(true);
  resEl.style.display='none';

  setTimeout(()=>{
    try{
      const {html,meta} = renderFullPlan(age,gender,height,weight,activity,goal);
      showResult(html);
      showLoading(false);
      window._lastGenerated = { inputs:{age,gender,height,weight,activity,goal}, planHtml: html, meta };
    }catch(err){
      console.error('render error',err);
      showLoading(false);
      resEl.style.display='block';
      resEl.innerHTML = `<div class="small-muted">حدث خطأ أثناء إعداد الخطة. افتح Console للتفاصيل.</div>`;
    }
  }, 500);
});

/* Save / Load / Clear Buttons */
btnSave.addEventListener('click', ()=>{
  const state = window._lastGenerated || null;
  if(!state || !state.inputs){
    const age = Number(document.getElementById('age').value);
    const gender = document.getElementById('gender').value;
    const height = Number(document.getElementById('height').value);
    const weight = Number(document.getElementById('weight').value);
    const activity = Number(document.getElementById('activity').value);
    const goal = document.getElementById('goal').value;
    const fake = { inputs:{age,gender,height,weight,activity,goal}, planHtml: resEl.innerHTML || '' };
    const ok = saveState(fake);
    if(ok) alert('تم حفظ المدخلات محلياً. يمكنك استرجاعها لاحقاً.');
    else alert('فشل الحفظ — تحقق من إعدادات المتصفح.');
    return;
  }
  const ok = saveState(state);
  if(ok) alert('تم حفظ الخطة والمحافظة على التقدم محلياً.');
  else alert('فشل الحفظ — تأكد من إعدادات المتصفح.');
});

btnLoad.addEventListener('click', ()=>{
  const s = loadState();
  if(!s){ alert('لا يوجد حفظ محلي'); return; }
  const i = s.inputs || {};
  document.getElementById('age').value = i.age || '';
  document.getElementById('gender').value = i.gender || '';
  document.getElementById('height').value = i.height || '';
  document.getElementById('weight').value = i.weight || '';
  document.getElementById('activity').value = i.activity || '';
  document.getElementById('goal').value = i.goal || '';
  if(s.planHtml){
    showResult(`<div class="small-muted" style="margin-bottom:10px">تم استرجاع الحفظ المحلي.</div>` + s.planHtml);
  } else {
    alert('تم استرجاع المدخلات فقط.');
  }
});

btnClear.addEventListener('click', ()=>{
  if(confirm('هل تريد مسح الحفظ المحلي؟')){ clearState(); alert('تم المسح.'); }
});
</script>
